name: Deploy

on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: Copy repo files to remote
    runs-on: ubuntu-latest
    steps:
      - name: Docker stop
        uses: appleboy/ssh-action@master
        with:
          host: 77.73.132.55
          username: root
          key: ${{ secrets.LAST_ONE_SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 22
          script: |
            docker stop ${{ secrets.DOCKER_CONTAINER_ID }}
      - name: Checkout
        uses: actions/checkout@v2
        with:
          ref: 'master'
      - name: Create .env file
        run: |
            echo "SECRET_KEY=${SECRET_KEY}" >> .env
            echo "EMAIL_HOST_USER=${EMAIL_HOST_USER}" >> .env
            echo "EMAIL_HOST_PASSWORD=${EMAIL_HOST_PASSWORD}" >> .env
            echo "HOST=${HOST}" >> .env
            echo "TELEGRAM_TOKEN=${TELEGRAM_TOKEN}" >> .env
            echo "DB_PASSWORD=${DB_PASSWORD}" >> .env
            echo "POSTGRES_USER=${POSTGRES_USER}" >> .env
            echo "POSTGRES_DB=${POSTGRES_DB}" >> .env
            echo "PASSWORD_FINISH=${PASSWORD_FINISH}" >> .env
      - name: Copy repo files to remote
        uses: appleboy/scp-action@v0.1.4
        with:
          host: 77.73.132.55
          username: root
          key: ${{ secrets.LAST_ONE_SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 22
          source: .
          target: '/root/dmitry/PYCAB_TIMEWEB'
          overwrite: true
      - name: Copy .env to remote
        uses: appleboy/scp-action@v0.1.4
        with:
          host: 77.73.132.55
          username: root
          key: ${{ secrets.LAST_ONE_SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 22
          source: .env
          target: '/root/dmitry/PYCAB_TIMEWEB'
          overwrite: true

# выводило список файлов. не отправляло файлы. 
#          script: |
#                  ls -al
#                  whoami
# rsync -avz --progress $GITHUB_WORKSPACE/ root@77.73.132.55:/



#script: |
#            ls -al



#      - name: Create .env file

#      - name: Copy repo files to remote
#        uses: appleboy/scp-action@v0.1.4
#        with:
#          host: ${ secrets.HOST_IP_ADRESS }
#          username: root
#          key: ${{ secrets.LAST_ONE_SSH_PRIVATE_KEY }}
#          port: 22
#          passphrase: ${{ secrets.SSH_PASSPHRASE }}
#          source: ".env"
#          target: '/home'
